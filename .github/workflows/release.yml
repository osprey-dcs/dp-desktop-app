name: Release dp-desktop-app

on:
  push:
    tags:
      - 'rel-*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Extract version from tag
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#rel-}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Checkout dp-grpc
        uses: actions/checkout@v4
        with:
          repository: osprey-dcs/dp-grpc
          ref: rel-${{ env.VERSION }}
          path: dp-grpc

      - name: Build and install dp-grpc
        run: |
          cd dp-grpc
          mvn -B install -DskipTests

      - name: Checkout dp-service
        uses: actions/checkout@v4
        with:
          repository: osprey-dcs/dp-service
          ref: rel-${{ env.VERSION }}
          path: dp-service

      - name: Build and install dp-service
        run: |
          cd dp-service
          mvn -B install -DskipTests

      - name: Build shaded JAR
        run: mvn -B -DskipTests package

      - name: Verify shaded JAR exists
        run: |
          ls -l target
          test -f "target/dp-desktop-app-1.12.0-shaded.jar"

      - name: Prepare release artifact
        run: |
          mkdir -p release
          
          SHADED_JAR=$(ls target/dp-desktop-app-*-shaded.jar | head -n 1)
          
          if [ ! -f "$SHADED_JAR" ]; then
            echo "ERROR: shaded JAR not found"
            ls -la target
            exit 1
          fi
          
          cp "$SHADED_JAR" "release/dp-desktop-app-${VERSION}.jar"
        
      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/dp-desktop-app-${VERSION}.jar
